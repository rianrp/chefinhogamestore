<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Admin - Chefinho Gaming Store</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="admin.css">
</head>
<body>
    <!-- Login -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h1>Admin Panel</h1>
            <p>Chefinho Gaming Store</p>
            
            <div id="loginAlert"></div>
            
            <form id="loginForm">
                <div class="input-group">
                    <label>Usu√°rio</label>
                    <input type="text" id="username" required placeholder="admin">
                </div>
                <div class="input-group">
                    <label>Senha</label>
                    <input type="password" id="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" class="btn-primary" id="loginBtn">
                    Entrar
                </button>
            </form>
        </div>
    </div>
    
    <!-- Admin Panel -->
    <div id="adminPanel" class="admin-panel">
        <!-- Topbar -->
        <div class="topbar">
            <div class="container">
                <div class="topbar-content">
                    <h1>Chefinho Admin</h1>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div class="user-badge">
                            <i class="fas fa-user-circle"></i>
                            <span id="loggedUser">admin</span>
                        </div>
                        <button class="btn-logout" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Sair
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="container">
            <div id="alertContainer"></div>
            
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-label">Total de Produtos</div>
                    <div class="stat-value" id="totalProducts">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Produtos Ativos</div>
                    <div class="stat-value" id="activeProducts">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Categorias</div>
                    <div class="stat-value" id="totalCategories">0</div>
                </div>
                <div class="stat-box" style="border-left: 3px solid #FCD34D;">
                    <div class="stat-label">An√∫ncios Ativos</div>
                    <div class="stat-value" id="totalAnuncios">0</div>
                </div>
            </div>
            
            <!-- Bot√£o Adicionar -->
            <div class="section">
                <button class="btn-gradient" onclick="openModal()" style="width: 100%;">
                    <i class="fas fa-plus"></i>
                    Adicionar Novo Produto
                </button>
            </div>
            
            <!-- Lista de Produtos -->
            <div class="section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">
                            Produtos
                            <span class="badge" id="productCount">0</span>
                        </h2>
                    </div>
                    <button class="btn-outline" onclick="loadProducts()">
                        <i class="fas fa-sync-alt"></i> Atualizar
                    </button>
                </div>
                
                <div id="productsList" class="product-list">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Carregando...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Adicionar Produto -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Novo Produto</h2>
                <button class="modal-close" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    <div class="form-grid">
                        <div class="form-field">
                            <label>Nome do Produto</label>
                            <input type="text" id="productName" required placeholder="Ex: Rucoy Online - Conta Level 500">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-field">
                                <label>Categoria</label>
                                <select id="productCategory" required>
                                    <option value="">Selecione...</option>
                                    <option value="freefire">Free Fire</option>
                                    <option value="mage">Rucoy Mage</option>
                                    <option value="kina">Rucoy Knight</option>
                                    <option value="pally">Rucoy Paladin</option>
                                    <option value="supercell">Supercell Games</option>
                                    <option value="itens">Itens Gerais</option>
                                    <option value="geral">Geral</option>
                                    <option value="roblox">Roblox</option>
                                </select>
                            </div>
                            
                            <div class="form-field">
                                <label>Pre√ßo (R$) (Opcional)</label>
                                <input type="number" id="productPrice" min="0" step="0.01" placeholder="150.00">
                            </div>
                        </div>
                        
                        <div class="form-field">
                            <label>Pre√ßo KKs (Opcional)</label>
                            <input type="number" id="productKks" min="0" step="0.01" placeholder="100.00">
                        </div>
                        
                        <div class="form-field">
                            <label>Imagem do Produto</label>
                            
                            <input type="file" id="productImageFile" accept="image/*" class="file-input-hidden">
                            <input type="hidden" id="productImage">
                            
                            <div class="image-upload-wrapper" id="imageUploadWrapper">
                                <img id="imagePreview" class="image-current" alt="Sem imagem" src="">
                                <button type="button" class="btn-edit-image" id="btnEditImage">
                                    <i class="fas fa-camera"></i> Editar
                                </button>
                            </div>
                            
                            <div id="uploadProgress" style="display: none; margin-top: 12px; color: #FCD34D; text-align: center;">
                                <i class="fas fa-spinner fa-spin"></i> Enviando imagem...
                            </div>
                        </div>
                        
                        <div class="form-field">
                            <label>Descri√ß√£o (Opcional)</label>
                            <textarea id="productDescription" placeholder="Informa√ß√µes adicionais do produto..."></textarea>
                        </div>

                        <!-- Se√ß√£o An√∫ncio -->
                        <div class="anuncio-section" style="border: 1px solid rgba(252, 211, 77, 0.3); border-radius: 12px; padding: 20px; margin-top: 10px; background: rgba(252, 211, 77, 0.05);">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
                                <i class="fas fa-bullhorn" style="color: #FCD34D; font-size: 1.2rem;"></i>
                                <label style="font-weight: 700; color: #FCD34D; margin: 0;">An√∫ncio de Terceiro</label>
                            </div>
                            
                            <div class="form-field" style="margin-bottom: 12px;">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="isAnuncio" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span>Este produto √© um an√∫ncio de anunciante</span>
                                </label>
                            </div>

                            <div id="anuncioFields" style="display: none;">
                                <div class="form-row">
                                    <div class="form-field">
                                        <label>Plano do An√∫ncio</label>
                                        <select id="anuncioPlano">
                                            <option value="basico">B√°sico - 2 dias (R$ 5)</option>
                                            <option value="pro" selected>Pro - 5 dias (R$ 10)</option>
                                            <option value="elite">Elite - 30 dias (R$ 15)</option>
                                        </select>
                                    </div>
                                    <div class="form-field">
                                        <label>Dura√ß√£o</label>
                                        <div id="anuncioDuracao" style="padding: 10px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; color: #A78BFA; font-weight: 600; text-align: center;">5 dias</div>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-field">
                                        <label>Nome do Anunciante</label>
                                        <input type="text" id="anuncianteNome" placeholder="Nome do cliente anunciante">
                                    </div>
                                    <div class="form-field">
                                        <label>WhatsApp do Anunciante</label>
                                        <input type="text" id="anuncianteWhatsapp" placeholder="5569912345678">
                                    </div>
                                </div>
                                <div class="form-field">
                                    <label>Expira√ß√£o</label>
                                    <div id="anuncioExpiracao" style="padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; color: #10B981; font-size: 0.9rem;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn-gradient" id="submitBtn">
                            <i class="fas fa-save"></i> Salvar Produto
                        </button>
                        <button type="button" class="btn-outline" onclick="closeModal()">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Confirma√ß√£o -->
    <div id="confirmModal" class="modal">
        <div class="modal-content confirm-modal">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-exclamation-triangle" style="color: #F59E0B;"></i>
                    Confirmar Exclus√£o
                </h2>
            </div>
            <div class="modal-body">
                <p id="confirmMessage" style="color: #A1A1AA; font-size: 1rem; line-height: 1.5;"></p>
                <div class="form-actions" style="margin-top: 24px;">
                    <button class="btn-danger" id="confirmDeleteBtn" onclick="confirmDelete()">
                        <i class="fas fa-trash"></i> Remover
                    </button>
                    <button type="button" class="btn-outline" onclick="closeConfirmModal()">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Supabase Client -->
    <script src="../js/supabase-client.js"></script>
    
    <script>
        let products = [];
        let categories = [];
        let productToDelete = null;
        
        // Modal Produto
        function openModal() {
            document.getElementById('productModal').classList.add('active');
            document.getElementById('modalTitle').textContent = 'Novo Produto';
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-save"></i> Salvar Produto';
            document.body.style.overflow = 'hidden';
        }
        
        function closeModal() {
            document.getElementById('productModal').classList.remove('active');
            document.body.style.overflow = '';
            resetForm();
        }
        
        function resetForm() {
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('productImage').value = '';
            document.getElementById('imagePreview').src = '';
            document.getElementById('isAnuncio').checked = false;
            document.getElementById('anuncioFields').style.display = 'none';
        }
        
        // Editar produto
        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            // Preencher formul√°rio
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name || '';
            document.getElementById('productCategory').value = product.category || '';
            document.getElementById('productPrice').value = product.rl_price || '';
            document.getElementById('productKks').value = product.kks_price || '';
            document.getElementById('productImage').value = product.image_url || '';
            document.getElementById('productDescription').value = product.description || '';
            
            // Mostrar preview se tiver imagem
            if (product.image_url) {
                document.getElementById('imagePreview').src = product.image_url;
            }

            // Preencher campos de an√∫ncio
            const isAnuncioCheck = document.getElementById('isAnuncio');
            isAnuncioCheck.checked = product.is_anuncio || false;
            document.getElementById('anuncioFields').style.display = product.is_anuncio ? 'block' : 'none';
            if (product.is_anuncio) {
                document.getElementById('anuncioPlano').value = product.anuncio_plano || 'pro';
                document.getElementById('anuncianteNome').value = product.anunciante_nome || '';
                document.getElementById('anuncianteWhatsapp').value = product.anunciante_whatsapp || '';
                updateAnuncioDuracao();
                updateAnuncioExpiracao(product.anuncio_inicio, product.anuncio_fim);
            }
            
            // Atualizar t√≠tulo do modal
            document.getElementById('modalTitle').textContent = 'Editar Produto';
            document.getElementById('submitBtn').innerHTML = '<i class=\"fas fa-save\"></i> Atualizar Produto';
            
            // Abrir modal
            document.getElementById('productModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        // Remover imagem (n√£o usado mais, mas mantido para compatibilidade)
        function removeImage() {
            document.getElementById('imagePreview').src = '';
            document.getElementById('productImage').value = '';
            document.getElementById('productImageFile').value = '';
        }
        
        // Fechar modal clicando fora
        window.addEventListener('click', (e) => {
            const modal = document.getElementById('productModal');
            if (e.target === modal) {
                closeModal();
            }
        });
        
        // Fechar modal com ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modal = document.getElementById('productModal');
                if (modal.classList.contains('active')) {
                    closeModal();
                }
            }
        });
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            setupEventListeners();
        });
        
        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('productForm').addEventListener('submit', handleAddProduct);
            
            // Bot√£o editar imagem
            const btnEditImage = document.getElementById('btnEditImage');
            const fileInput = document.getElementById('productImageFile');
            
            btnEditImage.addEventListener('click', () => {
                fileInput.click();
            });
            
            // Upload de imagem
            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleImageUpload(file);
                }
            });
        }
        
        // Upload de imagem com preview
        async function handleImageUpload(file) {
            if (!file.type.startsWith('image/')) {
                showAlert('‚ùå Por favor, selecione apenas imagens', 'error');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showAlert('‚ùå Imagem muito grande! M√°ximo 5MB', 'error');
                return;
            }
            
            const progress = document.getElementById('uploadProgress');
            const preview = document.getElementById('imagePreview');
            const urlInput = document.getElementById('productImage');
            
            try {
                progress.style.display = 'block';
                
                // Upload para ImageKit
                const url = await imageKit.uploadImage(file, 'produtos');
                
                urlInput.value = url;
                preview.src = url;
                
                showAlert('‚úÖ Imagem enviada!', 'success');
                setTimeout(() => document.getElementById('alertContainer').innerHTML = '', 2000);
            } catch (error) {
                showAlert('‚ùå Erro ao enviar: ' + error.message, 'error');
            } finally {
                progress.style.display = 'none';
            }
        }
        
        // Autentica√ß√£o
        
        async function checkAuth() {
            const token = localStorage.getItem('admin_token');
            
            if (token) {
                // Token existe, validar com Supabase
                const isValid = await supabase.validateToken(token);
                
                if (isValid) {
                    supabase.setToken(token);
                    showAdminPanel();
                    return;
                }
                
                // Token inv√°lido
                localStorage.removeItem('admin_token');
            }
            
            showLoginScreen();
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            
            const btn = document.getElementById('loginBtn');
            const alertDiv = document.getElementById('loginAlert');
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                btn.disabled = true;
                btn.textContent = 'Entrando...';
                
                const result = await supabase.adminLogin(username, password);
                
                if (result.success) {
                    showAdminPanel();
                } else {
                    alertDiv.innerHTML = `<div class="alert error">${result.error}</div>`;
                    setTimeout(() => alertDiv.innerHTML = '', 3000);
                }
            } catch (error) {
                alertDiv.innerHTML = '<div class="alert error">Erro de conex√£o</div>';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Entrar';
            }
        }
        
        function logout() {
            supabase.logout();
            showLoginScreen();
        }
        
        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('adminPanel').style.display = 'none';
        }
        
        function showAdminPanel() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadProducts();
            loadCategories();
        }
        
        // =====================================================
        // Produtos
        // =====================================================
        
        async function loadProducts() {
            try {
                showAlert('Carregando produtos...', 'info');
                
                products = await supabase.getAllProducts();
                renderProducts();
                updateStats();
                
                showAlert('Produtos carregados!', 'success');
                setTimeout(clearAlert, 2000);
            } catch (error) {
                showAlert('Erro ao carregar: ' + error.message, 'error');
            }
        }
        
        async function loadCategories() {
            try {
                categories = await supabase.getCategories();
                
                // Atualizar select de categorias
                const select = document.getElementById('productCategory');
                select.innerHTML = '<option value="">Selecione...</option>';
                categories.forEach(cat => {
                    select.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
                });
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
            }
        }
        
        function renderProducts() {
            const container = document.getElementById('productsList');
            
            if (!products || products.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <p>Nenhum produto cadastrado</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = products.map(p => {
                const isAnuncioAtivo = p.is_anuncio && p.anuncio_fim && new Date(p.anuncio_fim) > new Date();
                const planoColors = { basico: '#8B5CF6', pro: '#FCD34D', elite: '#F97316' };
                const planoColor = planoColors[p.anuncio_plano] || '#8B5CF6';
                const tempoRestante = isAnuncioAtivo ? getTempoRestante(p.anuncio_fim) : '';
                
                return `
                <div class="product-item" style="${isAnuncioAtivo ? `border-left: 3px solid ${planoColor};` : ''}">
                    ${p.image_url ? 
                        `<img src="${p.image_url}" class="product-thumb" alt="${p.name}">` : 
                        `<div class="product-thumb-placeholder"><i class="fas fa-image"></i></div>`
                    }
                    <div class="product-info">
                        <div class="product-name">
                            ${p.name || 'Sem nome'}
                            ${isAnuncioAtivo ? `<span style="background: ${planoColor}; color: ${p.anuncio_plano === 'pro' ? '#1a1a2e' : '#fff'}; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 700; margin-left: 8px; text-transform: uppercase;">üì¢ ${p.anuncio_plano}</span>` : ''}
                        </div>
                        <div class="product-meta">
                            <span class="product-price">R$ ${(p.rl_price || 0).toFixed(2)}</span>
                            <span><i class="fas fa-folder"></i> ${getCategoryName(p.category)}</span>
                            ${p.kks_price ? `<span><i class="fas fa-coins"></i> ${p.kks_price} KKs</span>` : ''}
                            <span style="color: ${p.is_active ? '#10B981' : '#EF4444'}">
                                <i class="fas fa-circle" style="font-size: 0.5rem;"></i> ${p.is_active ? 'Ativo' : 'Inativo'}
                            </span>
                            ${isAnuncioAtivo ? `<span style="color: #FCD34D;"><i class="fas fa-clock"></i> ${tempoRestante}</span>` : ''}
                            ${p.is_anuncio && !isAnuncioAtivo && p.anuncio_fim ? `<span style="color: #EF4444;"><i class="fas fa-times-circle"></i> An√∫ncio expirado</span>` : ''}
                            ${p.anunciante_nome ? `<span style="color: #A78BFA;"><i class="fas fa-user"></i> ${p.anunciante_nome}</span>` : ''}
                        </div>
                    </div>
                    <div class="product-actions">
                        <div class="product-order-controls" style="display: flex; flex-direction: column; gap: 4px; margin-right: 8px;">
                            <button class="btn-icon btn-order" onclick="moveProductUp('${p.id}')" title="Mover para cima">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                            <button class="btn-icon btn-order" onclick="moveProductDown('${p.id}')" title="Mover para baixo">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        <button class="btn-icon" onclick="editProduct('${p.id}')" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon danger" onclick="deleteProduct('${p.id}')" title="Remover">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            `}).join('');
        }
        
        function getCategoryName(catId) {
            const cat = categories.find(c => c.id === catId);
            return cat ? cat.name : catId || 'Sem categoria';
        }
        
        function updateStats() {
            const active = products.filter(p => p.is_active).length;
            const cats = new Set(products.map(p => p.category).filter(Boolean));
            const anunciosAtivos = products.filter(p => p.is_anuncio && p.anuncio_fim && new Date(p.anuncio_fim) > new Date()).length;
            
            document.getElementById('totalProducts').textContent = products.length;
            document.getElementById('activeProducts').textContent = active;
            document.getElementById('totalCategories').textContent = cats.size;
            document.getElementById('productCount').textContent = products.length;
            document.getElementById('totalAnuncios').textContent = anunciosAtivos;
        }
        
        async function handleAddProduct(e) {
            e.preventDefault();
            
            const btn = document.getElementById('submitBtn');
            const originalHTML = btn.innerHTML;
            const productId = document.getElementById('productId').value;
            const isEditing = !!productId;
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
                
                const isAnuncio = document.getElementById('isAnuncio').checked;
                const anuncioPlano = document.getElementById('anuncioPlano').value;
                
                // Calcular datas do an√∫ncio
                const planoDias = { basico: 2, pro: 5, elite: 30 };
                let anuncioInicio = null;
                let anuncioFim = null;
                
                if (isAnuncio) {
                    // Se est√° editando e j√° tinha an√∫ncio ativo, manter o in√≠cio original
                    const existingProduct = products.find(p => p.id === productId);
                    if (isEditing && existingProduct && existingProduct.is_anuncio && existingProduct.anuncio_inicio) {
                        anuncioInicio = existingProduct.anuncio_inicio;
                        // Recalcular fim apenas se mudou o plano
                        if (existingProduct.anuncio_plano !== anuncioPlano) {
                            const inicio = new Date(anuncioInicio);
                            anuncioFim = new Date(inicio.getTime() + planoDias[anuncioPlano] * 24 * 60 * 60 * 1000).toISOString();
                        } else {
                            anuncioFim = existingProduct.anuncio_fim;
                        }
                    } else {
                        anuncioInicio = new Date().toISOString();
                        anuncioFim = new Date(Date.now() + planoDias[anuncioPlano] * 24 * 60 * 60 * 1000).toISOString();
                    }
                }

                const productData = {
                    name: document.getElementById('productName').value,
                    category: document.getElementById('productCategory').value,
                    rl_price: parseFloat(document.getElementById('productPrice').value) || 0,
                    kks_price: parseFloat(document.getElementById('productKks').value) || 0,
                    image_url: document.getElementById('productImage').value || '',
                    description: document.getElementById('productDescription').value || '',
                    quantity: 1,
                    is_active: true,
                    is_anuncio: isAnuncio,
                    anuncio_plano: isAnuncio ? anuncioPlano : null,
                    anuncio_inicio: anuncioInicio,
                    anuncio_fim: anuncioFim,
                    anunciante_nome: isAnuncio ? (document.getElementById('anuncianteNome').value || null) : null,
                    anunciante_whatsapp: isAnuncio ? (document.getElementById('anuncianteWhatsapp').value || null) : null
                };
                
                if (isEditing) {
                    // Atualizar produto existente
                    productData.id = productId;
                    await supabase.updateProduct(productId, productData);
                    showAlert('‚úÖ Produto atualizado!', 'success');
                } else {
                    // Criar novo produto
                    productData.id = Date.now().toString();
                    await supabase.addProduct(productData);
                    showAlert('‚úÖ Produto adicionado!', 'success');
                }
                
                closeModal();
                await loadProducts();
                
                setTimeout(() => document.getElementById('alertContainer').innerHTML = '', 3000);
            } catch (error) {
                showAlert('‚ùå Erro: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }
        
        async function deleteProduct(id) {
            const product = products.find(p => p.id === id);
            const productName = product ? product.name : 'este produto';
            
            productToDelete = id;
            document.getElementById('confirmMessage').innerHTML = 
                `Tem certeza que deseja remover o produto <strong style="color: #FAFAFA;">"${productName}"</strong>?<br><br>` +
                `<span style="color: #71717A; font-size: 0.9rem;">Esta a√ß√£o n√£o pode ser desfeita.</span>`;
            openConfirmModal();
        }
        
        // Modal Confirma√ß√£o
        function openConfirmModal() {
            document.getElementById('confirmModal').classList.add('active');
        }
        
        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
            productToDelete = null;
        }
        
        async function confirmDelete() {
            if (!productToDelete) return;
            
            const btn = document.getElementById('confirmDeleteBtn');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Removendo...';
            
            try {
                await supabase.hardDeleteProduct(productToDelete);
                closeConfirmModal();
                await loadProducts();
                showAlert('‚úÖ Produto removido!', 'success');
                setTimeout(() => document.getElementById('alertContainer').innerHTML = '', 3000);
            } catch (error) {
                showAlert('‚ùå Erro: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
                productToDelete = null;
            }
        }
        
        function showAlert(message, type = 'info') {
            document.getElementById('alertContainer').innerHTML = `<div class="alert ${type}">${message}</div>`;
        }
        
        function clearAlert() {
            document.getElementById('alertContainer').innerHTML = '';
        }

        // =====================================================
        // Reordena√ß√£o de Produtos
        // =====================================================

        async function moveProductUp(productId) {
            try {
                showAlert('‚¨ÜÔ∏è Movendo produto para cima...', 'info');
                
                const result = await supabase.moveProductUp(productId);
                
                if (result) {
                    await loadProducts();
                    showAlert('‚úÖ Produto movido para cima!', 'success');
                    setTimeout(clearAlert, 2000);
                } else {
                    showAlert('‚ÑπÔ∏è Produto j√° est√° no topo', 'info');
                    setTimeout(clearAlert, 2000);
                }
            } catch (error) {
                console.error('Erro ao mover produto:', error);
                showAlert('‚ùå Erro ao mover produto', 'error');
            }
        }

        async function moveProductDown(productId) {
            try {
                showAlert('‚¨áÔ∏è Movendo produto para baixo...', 'info');
                
                const result = await supabase.moveProductDown(productId);
                
                if (result) {
                    await loadProducts();
                    showAlert('‚úÖ Produto movido para baixo!', 'success');
                    setTimeout(clearAlert, 2000);
                } else {
                    showAlert('‚ÑπÔ∏è Produto j√° est√° no final', 'info');
                    setTimeout(clearAlert, 2000);
                }
            } catch (error) {
                console.error('Erro ao mover produto:', error);
                showAlert('‚ùå Erro ao mover produto', 'error');
            }
        }

        async function moveProductToTop(productId) {
            try {
                showAlert('‚¨ÜÔ∏è‚¨ÜÔ∏è Movendo produto para o topo...', 'info');
                
                await supabase.moveProductToTop(productId);
                await loadProducts();
                
                showAlert('‚úÖ Produto movido para o topo!', 'success');
                setTimeout(clearAlert, 2000);
            } catch (error) {
                console.error('Erro ao mover produto:', error);
                showAlert('‚ùå Erro ao mover produto', 'error');
            }
        }

        async function moveProductToBottom(productId) {
            try {
                showAlert('‚¨áÔ∏è‚¨áÔ∏è Movendo produto para o final...', 'info');
                
                await supabase.moveProductToBottom(productId);
                await loadProducts();
                
                showAlert('‚úÖ Produto movido para o final!', 'success');
                setTimeout(clearAlert, 2000);
            } catch (error) {
                console.error('Erro ao mover produto:', error);
                showAlert('‚ùå Erro ao mover produto', 'error');
            }
        }

        // =====================================================
        // An√∫ncio - Fun√ß√µes auxiliares
        // =====================================================

        // Toggle campos de an√∫ncio
        document.addEventListener('DOMContentLoaded', () => {
            const isAnuncioCheck = document.getElementById('isAnuncio');
            if (isAnuncioCheck) {
                isAnuncioCheck.addEventListener('change', function() {
                    document.getElementById('anuncioFields').style.display = this.checked ? 'block' : 'none';
                    if (this.checked) updateAnuncioDuracao();
                });
            }

            const anuncioPlano = document.getElementById('anuncioPlano');
            if (anuncioPlano) {
                anuncioPlano.addEventListener('change', updateAnuncioDuracao);
            }
        });

        function updateAnuncioDuracao() {
            const plano = document.getElementById('anuncioPlano').value;
            const duracaoMap = { basico: '2 dias', pro: '5 dias', elite: '30 dias' };
            const duracaoEl = document.getElementById('anuncioDuracao');
            if (duracaoEl) {
                duracaoEl.textContent = duracaoMap[plano] || '5 dias';
            }
            // Atualizar previs√£o de expira√ß√£o para novo an√∫ncio
            const planoDias = { basico: 2, pro: 5, elite: 30 };
            const fim = new Date(Date.now() + planoDias[plano] * 24 * 60 * 60 * 1000);
            const expEl = document.getElementById('anuncioExpiracao');
            if (expEl) {
                expEl.innerHTML = `<i class="fas fa-calendar-check"></i> Expira em: <strong>${fim.toLocaleDateString('pt-BR')} √†s ${fim.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}</strong>`;
            }
        }

        function updateAnuncioExpiracao(inicio, fim) {
            const expEl = document.getElementById('anuncioExpiracao');
            if (!expEl) return;
            if (fim) {
                const fimDate = new Date(fim);
                const agora = new Date();
                const expirado = fimDate < agora;
                if (expirado) {
                    expEl.innerHTML = `<i class="fas fa-times-circle" style="color: #EF4444;"></i> <span style="color: #EF4444;">Expirado em ${fimDate.toLocaleDateString('pt-BR')} √†s ${fimDate.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}</span>`;
                } else {
                    const restante = getTempoRestante(fim);
                    expEl.innerHTML = `<i class="fas fa-clock"></i> Expira em: <strong>${fimDate.toLocaleDateString('pt-BR')} √†s ${fimDate.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}</strong> (${restante})`;
                }
            }
        }

        function getTempoRestante(fimStr) {
            const fim = new Date(fimStr);
            const agora = new Date();
            const diff = fim - agora;
            if (diff <= 0) return 'Expirado';
            const dias = Math.floor(diff / (1000 * 60 * 60 * 24));
            const horas = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            if (dias > 0) return `${dias}d ${horas}h restantes`;
            const minutos = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            return `${horas}h ${minutos}m restantes`;
        }
    </script>
</body>
</html>
