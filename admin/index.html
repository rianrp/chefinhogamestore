<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Admin - Chefinho Gaming Store</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="admin.css">
</head>
<body>
    <!-- Login -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h1>Admin Panel</h1>
            <p>Chefinho Gaming Store</p>
            
            <div id="loginAlert"></div>
            
            <form id="loginForm">
                <div class="input-group">
                    <label>Usuário</label>
                    <input type="text" id="username" required placeholder="admin">
                </div>
                <div class="input-group">
                    <label>Senha</label>
                    <input type="password" id="password" required placeholder="••••••••">
                </div>
                <button type="submit" class="btn-primary" id="loginBtn">
                    Entrar
                </button>
            </form>
        </div>
    </div>
    
    <!-- Admin Panel -->
    <div id="adminPanel" class="admin-panel">
        <!-- Topbar -->
        <div class="topbar">
            <div class="container">
                <div class="topbar-content">
                    <h1>Chefinho Admin</h1>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div class="user-badge">
                            <i class="fas fa-user-circle"></i>
                            <span id="loggedUser">admin</span>
                        </div>
                        <button class="btn-logout" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Sair
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="container">
            <div id="alertContainer"></div>
            
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-label">Total de Produtos</div>
                    <div class="stat-value" id="totalProducts">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Produtos Ativos</div>
                    <div class="stat-value" id="activeProducts">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Categorias</div>
                    <div class="stat-value" id="totalCategories">0</div>
                </div>
            </div>
            
            <!-- Botão Adicionar -->
            <div class="section">
                <button class="btn-gradient" onclick="openModal()" style="width: 100%;">
                    <i class="fas fa-plus"></i>
                    Adicionar Novo Produto
                </button>
            </div>
            
            <!-- Lista de Produtos -->
            <div class="section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">
                            Produtos
                            <span class="badge" id="productCount">0</span>
                        </h2>
                    </div>
                    <button class="btn-outline" onclick="loadProducts()">
                        <i class="fas fa-sync-alt"></i> Atualizar
                    </button>
                </div>
                
                <div id="productsList" class="product-list">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Carregando...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Adicionar Produto -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Novo Produto</h2>
                <button class="modal-close" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    <div class="form-grid">
                        <div class="form-field">
                            <label>Nome do Produto</label>
                            <input type="text" id="productName" required placeholder="Ex: Rucoy Online - Conta Level 500">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-field">
                                <label>Categoria</label>
                                <select id="productCategory" required>
                                    <option value="">Selecione...</option>
                                    <option value="freefire">Free Fire</option>
                                    <option value="mage">Rucoy Mage</option>
                                    <option value="kina">Rucoy Knight</option>
                                    <option value="pally">Rucoy Paladin</option>
                                    <option value="supercell">Supercell Games</option>
                                    <option value="itens">Itens Gerais</option>
                                    <option value="geral">Geral</option>
                                    <option value="roblox">Roblox</option>
                                </select>
                            </div>
                            
                            <div class="form-field">
                                <label>Preço (R$)</label>
                                <input type="number" id="productPrice" min="0" step="0.01" required placeholder="150.00">
                            </div>
                        </div>
                        
                        <div class="form-field">
                            <label>Preço KKs (Opcional)</label>
                            <input type="number" id="productKks" min="0" step="0.01" placeholder="100.00">
                        </div>
                        
                        <div class="form-field">
                            <label>Imagem do Produto</label>
                            
                            <input type="file" id="productImageFile" accept="image/*" class="file-input-hidden">
                            <input type="hidden" id="productImage">
                            
                            <div class="image-upload-wrapper" id="imageUploadWrapper">
                                <img id="imagePreview" class="image-current" alt="Sem imagem" src="">
                                <button type="button" class="btn-edit-image" id="btnEditImage">
                                    <i class="fas fa-camera"></i> Editar
                                </button>
                            </div>
                            
                            <div id="uploadProgress" style="display: none; margin-top: 12px; color: #FCD34D; text-align: center;">
                                <i class="fas fa-spinner fa-spin"></i> Enviando imagem...
                            </div>
                        </div>
                        
                        <div class="form-field">
                            <label>Descrição (Opcional)</label>
                            <textarea id="productDescription" placeholder="Informações adicionais do produto..."></textarea>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn-gradient" id="submitBtn">
                            <i class="fas fa-save"></i> Salvar Produto
                        </button>
                        <button type="button" class="btn-outline" onclick="closeModal()">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Confirmação -->
    <div id="confirmModal" class="modal">
        <div class="modal-content confirm-modal">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-exclamation-triangle" style="color: #F59E0B;"></i>
                    Confirmar Exclusão
                </h2>
            </div>
            <div class="modal-body">
                <p id="confirmMessage" style="color: #A1A1AA; font-size: 1rem; line-height: 1.5;"></p>
                <div class="form-actions" style="margin-top: 24px;">
                    <button class="btn-danger" id="confirmDeleteBtn" onclick="confirmDelete()">
                        <i class="fas fa-trash"></i> Remover
                    </button>
                    <button type="button" class="btn-outline" onclick="closeConfirmModal()">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Supabase Client -->
    <script src="../js/supabase-client.js"></script>
    
    <script>
        let products = [];
        let categories = [];
        let productToDelete = null;
        
        // Modal Produto
        function openModal() {
            document.getElementById('productModal').classList.add('active');
            document.getElementById('modalTitle').textContent = 'Novo Produto';
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-save"></i> Salvar Produto';
            document.body.style.overflow = 'hidden';
        }
        
        function closeModal() {
            document.getElementById('productModal').classList.remove('active');
            document.body.style.overflow = '';
            resetForm();
        }
        
        function resetForm() {
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('productImage').value = '';
            document.getElementById('imagePreview').src = '';
        }
        
        // Editar produto
        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            // Preencher formulário
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name || '';
            document.getElementById('productCategory').value = product.category || '';
            document.getElementById('productPrice').value = product.rl_price || '';
            document.getElementById('productKks').value = product.kks_price || '';
            document.getElementById('productImage').value = product.image_url || '';
            document.getElementById('productDescription').value = product.description || '';
            
            // Mostrar preview se tiver imagem
            if (product.image_url) {
                document.getElementById('imagePreview').src = product.image_url;
            }
            
            // Atualizar título do modal
            document.getElementById('modalTitle').textContent = 'Editar Produto';
            document.getElementById('submitBtn').innerHTML = '<i class=\"fas fa-save\"></i> Atualizar Produto';
            
            // Abrir modal
            document.getElementById('productModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        // Remover imagem (não usado mais, mas mantido para compatibilidade)
        function removeImage() {
            document.getElementById('imagePreview').src = '';
            document.getElementById('productImage').value = '';
            document.getElementById('productImageFile').value = '';
        }
        
        // Fechar modal clicando fora
        window.addEventListener('click', (e) => {
            const modal = document.getElementById('productModal');
            if (e.target === modal) {
                closeModal();
            }
        });
        
        // Fechar modal com ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modal = document.getElementById('productModal');
                if (modal.classList.contains('active')) {
                    closeModal();
                }
            }
        });
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            setupEventListeners();
        });
        
        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('productForm').addEventListener('submit', handleAddProduct);
            
            // Botão editar imagem
            const btnEditImage = document.getElementById('btnEditImage');
            const fileInput = document.getElementById('productImageFile');
            
            btnEditImage.addEventListener('click', () => {
                fileInput.click();
            });
            
            // Upload de imagem
            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleImageUpload(file);
                }
            });
        }
        
        // Upload de imagem com preview
        async function handleImageUpload(file) {
            if (!file.type.startsWith('image/')) {
                showAlert('❌ Por favor, selecione apenas imagens', 'error');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showAlert('❌ Imagem muito grande! Máximo 5MB', 'error');
                return;
            }
            
            const progress = document.getElementById('uploadProgress');
            const preview = document.getElementById('imagePreview');
            const urlInput = document.getElementById('productImage');
            
            try {
                progress.style.display = 'block';
                
                // Upload para ImageKit
                const url = await imageKit.uploadImage(file, 'produtos');
                
                urlInput.value = url;
                preview.src = url;
                
                showAlert('✅ Imagem enviada!', 'success');
                setTimeout(() => document.getElementById('alertContainer').innerHTML = '', 2000);
            } catch (error) {
                showAlert('❌ Erro ao enviar: ' + error.message, 'error');
            } finally {
                progress.style.display = 'none';
            }
        }
        
        // Autenticação
        
        async function checkAuth() {
            const token = localStorage.getItem('admin_token');
            
            if (token) {
                // Token existe, validar com Supabase
                const isValid = await supabase.validateToken(token);
                
                if (isValid) {
                    supabase.setToken(token);
                    showAdminPanel();
                    return;
                }
                
                // Token inválido
                localStorage.removeItem('admin_token');
            }
            
            showLoginScreen();
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            
            const btn = document.getElementById('loginBtn');
            const alertDiv = document.getElementById('loginAlert');
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                btn.disabled = true;
                btn.textContent = 'Entrando...';
                
                const result = await supabase.adminLogin(username, password);
                
                if (result.success) {
                    showAdminPanel();
                } else {
                    alertDiv.innerHTML = `<div class="alert error">${result.error}</div>`;
                    setTimeout(() => alertDiv.innerHTML = '', 3000);
                }
            } catch (error) {
                alertDiv.innerHTML = '<div class="alert error">Erro de conexão</div>';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Entrar';
            }
        }
        
        function logout() {
            supabase.logout();
            showLoginScreen();
        }
        
        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('adminPanel').style.display = 'none';
        }
        
        function showAdminPanel() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadProducts();
            loadCategories();
        }
        
        // =====================================================
        // Produtos
        // =====================================================
        
        async function loadProducts() {
            try {
                showAlert('Carregando produtos...', 'info');
                
                products = await supabase.getAllProducts();
                renderProducts();
                updateStats();
                
                showAlert('Produtos carregados!', 'success');
                setTimeout(clearAlert, 2000);
            } catch (error) {
                showAlert('Erro ao carregar: ' + error.message, 'error');
            }
        }
        
        async function loadCategories() {
            try {
                categories = await supabase.getCategories();
                
                // Atualizar select de categorias
                const select = document.getElementById('productCategory');
                select.innerHTML = '<option value="">Selecione...</option>';
                categories.forEach(cat => {
                    select.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
                });
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
            }
        }
        
        function renderProducts() {
            const container = document.getElementById('productsList');
            
            if (!products || products.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <p>Nenhum produto cadastrado</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = products.map(p => `
                <div class="product-item">
                    ${p.image_url ? 
                        `<img src="${p.image_url}" class="product-thumb" alt="${p.name}">` : 
                        `<div class="product-thumb-placeholder"><i class="fas fa-image"></i></div>`
                    }
                    <div class="product-info">
                        <div class="product-name">${p.name || 'Sem nome'}</div>
                        <div class="product-meta">
                            <span class="product-price">R$ ${(p.rl_price || 0).toFixed(2)}</span>
                            <span><i class="fas fa-folder"></i> ${getCategoryName(p.category)}</span>
                            ${p.kks_price ? `<span><i class="fas fa-coins"></i> ${p.kks_price} KKs</span>` : ''}
                            <span style="color: ${p.is_active ? '#10B981' : '#EF4444'}">
                                <i class="fas fa-circle" style="font-size: 0.5rem;"></i> ${p.is_active ? 'Ativo' : 'Inativo'}
                            </span>
                        </div>
                    </div>
                    <div class="product-actions">
                        <button class="btn-icon" onclick="editProduct('${p.id}')" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon danger" onclick="deleteProduct('${p.id}')" title="Remover">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function getCategoryName(catId) {
            const cat = categories.find(c => c.id === catId);
            return cat ? cat.name : catId || 'Sem categoria';
        }
        
        function updateStats() {
            const active = products.filter(p => p.is_active).length;
            const cats = new Set(products.map(p => p.category).filter(Boolean));
            
            document.getElementById('totalProducts').textContent = products.length;
            document.getElementById('activeProducts').textContent = active;
            document.getElementById('totalCategories').textContent = cats.size;
            document.getElementById('productCount').textContent = products.length;
        }
        
        async function handleAddProduct(e) {
            e.preventDefault();
            
            const btn = document.getElementById('submitBtn');
            const originalHTML = btn.innerHTML;
            const productId = document.getElementById('productId').value;
            const isEditing = !!productId;
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
                
                const productData = {
                    name: document.getElementById('productName').value,
                    category: document.getElementById('productCategory').value,
                    rl_price: parseFloat(document.getElementById('productPrice').value) || 0,
                    kks_price: parseFloat(document.getElementById('productKks').value) || 0,
                    image_url: document.getElementById('productImage').value || '',
                    description: document.getElementById('productDescription').value || '',
                    quantity: 1,
                    is_active: true
                };
                
                if (isEditing) {
                    // Atualizar produto existente
                    productData.id = productId;
                    await supabase.updateProduct(productId, productData);
                    showAlert('✅ Produto atualizado!', 'success');
                } else {
                    // Criar novo produto
                    productData.id = Date.now().toString();
                    await supabase.addProduct(productData);
                    showAlert('✅ Produto adicionado!', 'success');
                }
                
                closeModal();
                await loadProducts();
                
                setTimeout(() => document.getElementById('alertContainer').innerHTML = '', 3000);
            } catch (error) {
                showAlert('❌ Erro: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }
        
        async function deleteProduct(id) {
            const product = products.find(p => p.id === id);
            const productName = product ? product.name : 'este produto';
            
            productToDelete = id;
            document.getElementById('confirmMessage').innerHTML = 
                `Tem certeza que deseja remover o produto <strong style="color: #FAFAFA;">"${productName}"</strong>?<br><br>` +
                `<span style="color: #71717A; font-size: 0.9rem;">Esta ação não pode ser desfeita.</span>`;
            openConfirmModal();
        }
        
        // Modal Confirmação
        function openConfirmModal() {
            document.getElementById('confirmModal').classList.add('active');
        }
        
        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
            productToDelete = null;
        }
        
        async function confirmDelete() {
            if (!productToDelete) return;
            
            const btn = document.getElementById('confirmDeleteBtn');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Removendo...';
            
            try {
                await supabase.hardDeleteProduct(productToDelete);
                closeConfirmModal();
                await loadProducts();
                showAlert('✅ Produto removido!', 'success');
                setTimeout(() => document.getElementById('alertContainer').innerHTML = '', 3000);
            } catch (error) {
                showAlert('❌ Erro: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
                productToDelete = null;
            }
        }
        
        function showAlert(message, type = 'info') {
            document.getElementById('alertContainer').innerHTML = `<div class="alert ${type}">${message}</div>`;
        }
        
        function clearAlert() {
            document.getElementById('alertContainer').innerHTML = '';
        }
    </script>
</body>
</html>
