<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug API - Chefinho</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .card {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .btn {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn:hover {
            background: #0088ff;
        }
        .result {
            background: #000;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        .success { color: #00ff00; }
        .error { color: #ff4444; }
        .warning { color: #ffaa00; }
        .info { color: #00aaff; }
        h1, h2 { color: #ffffff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug API - Chefinho Gaming Store</h1>
        <p>Ferramenta para debugar a API e KV Store em produ√ß√£o</p>
        
        <div class="card">
            <h2>üì° Teste da API GET</h2>
            <button class="btn" onclick="testGetAPI()">Testar GET /api/get-products</button>
            <button class="btn" onclick="checkEnvironment()">Verificar Ambiente</button>
            <div id="getResult" class="result">Clique no bot√£o para testar...</div>
        </div>
        
        <div class="card">
            <h2>üìä An√°lise dos Dados</h2>
            <button class="btn" onclick="analyzeData()">Analisar Estrutura dos Dados</button>
            <div id="analysisResult" class="result">An√°lise aparecer√° aqui...</div>
        </div>
        
        <div class="card">
            <h2>üîÑ Teste da API POST</h2>
            <button class="btn" onclick="testPostAPI()">Testar POST /api/update-products</button>
            <div id="postResult" class="result">Resultado do POST aparecer√° aqui...</div>
        </div>
        
        <div class="card">
            <h2>üìù Logs em Tempo Real</h2>
            <button class="btn" onclick="clearLogs()">Limpar Logs</button>
            <div id="logs" class="result">Logs aparecer√£o aqui...</div>
        </div>
    </div>
    
    <script>
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            const prefix = type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            
            logsDiv.innerHTML += `<span class="${className}">[${timestamp}] ${prefix} ${message}</span>\n`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        function checkEnvironment() {
            log('Verificando ambiente...', 'info');
            const env = {
                hostname: window.location.hostname,
                protocol: window.location.protocol,
                userAgent: navigator.userAgent,
                timestamp: new Date().toISOString()
            };
            log(`Ambiente: ${JSON.stringify(env, null, 2)}`, 'info');
        }
        
        async function testGetAPI() {
            const resultDiv = document.getElementById('getResult');
            log('Iniciando teste GET API...', 'info');
            
            try {
                resultDiv.innerHTML = 'üîÑ Carregando...';
                
                const startTime = Date.now();
                const response = await fetch('/.netlify/functions/get-products');
                const endTime = Date.now();
                
                log(`Resposta recebida em ${endTime - startTime}ms`, 'success');
                log(`Status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // An√°lise dos dados
                const analysis = {
                    status: 'SUCCESS',
                    responseTime: `${endTime - startTime}ms`,
                    dataSource: data._debug?.source || 'unknown',
                    environment: data._debug?.environment || 'unknown',
                    productCount: data.products?.length || 0,
                    hasProducts: Array.isArray(data.products) && data.products.length > 0,
                    structure: {
                        hasSite: !!data.site,
                        hasTheme: !!data.theme,
                        hasCategories: !!data.categories,
                        hasProducts: !!data.products
                    },
                    debugInfo: data._debug || null
                };
                
                if (data.products && data.products.length > 0) {
                    analysis.sampleProducts = data.products.slice(0, 3).map(p => ({
                        id: p.id,
                        name: p.name,
                        category: p.category,
                        created_at: p.created_at
                    }));
                }
                
                resultDiv.innerHTML = JSON.stringify(analysis, null, 2);
                
                log(`‚úÖ GET API funcionando! ${analysis.productCount} produtos encontrados`, 'success');
                log(`üìä Fonte dos dados: ${analysis.dataSource}`, 'info');
                
            } catch (error) {
                const errorInfo = {
                    status: 'ERROR',
                    message: error.message,
                    timestamp: new Date().toISOString()
                };
                
                resultDiv.innerHTML = JSON.stringify(errorInfo, null, 2);
                log(`‚ùå Erro na API GET: ${error.message}`, 'error');
            }
        }
        
        async function analyzeData() {
            const resultDiv = document.getElementById('analysisResult');
            log('Analisando estrutura dos dados...', 'info');
            
            try {
                const response = await fetch('/.netlify/functions/get-products');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                const analysis = {
                    overview: {
                        totalProducts: data.products?.length || 0,
                        dataSource: data._debug?.source || 'unknown',
                        lastUpdate: data._debug?.timestamp || 'unknown'
                    },
                    categories: {},
                    recentProducts: [],
                    oldestProducts: [],
                    validation: {
                        allProductsHaveId: true,
                        allProductsHaveName: true,
                        allProductsHavePrice: true,
                        issues: []
                    }
                };
                
                if (data.products && Array.isArray(data.products)) {
                    // An√°lise por categoria
                    data.products.forEach(product => {
                        const cat = product.category || 'sem-categoria';
                        analysis.categories[cat] = (analysis.categories[cat] || 0) + 1;
                        
                        // Valida√ß√£o
                        if (!product.id) {
                            analysis.validation.allProductsHaveId = false;
                            analysis.validation.issues.push(`Produto sem ID: ${product.name}`);
                        }
                        if (!product.name) {
                            analysis.validation.allProductsHaveName = false;
                            analysis.validation.issues.push(`Produto sem nome: ID ${product.id}`);
                        }
                        if (!product.rl_price && !product.kks_price) {
                            analysis.validation.allProductsHavePrice = false;
                            analysis.validation.issues.push(`Produto sem pre√ßo: ${product.name}`);
                        }
                    });
                    
                    // Produtos mais recentes
                    const sortedByDate = data.products
                        .filter(p => p.created_at)
                        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    
                    analysis.recentProducts = sortedByDate.slice(0, 5).map(p => ({
                        name: p.name,
                        category: p.category,
                        created_at: p.created_at
                    }));
                    
                    analysis.oldestProducts = sortedByDate.slice(-3).map(p => ({
                        name: p.name,
                        category: p.category,
                        created_at: p.created_at
                    }));
                }
                
                resultDiv.innerHTML = JSON.stringify(analysis, null, 2);
                log(`üìä An√°lise conclu√≠da: ${analysis.overview.totalProducts} produtos`, 'success');
                
            } catch (error) {
                resultDiv.innerHTML = `ERRO: ${error.message}`;
                log(`‚ùå Erro na an√°lise: ${error.message}`, 'error');
            }
        }
        
        async function testPostAPI() {
            const resultDiv = document.getElementById('postResult');
            log('Testando API POST...', 'info');
            
            try {
                resultDiv.innerHTML = 'üîÑ Testando POST...';
                
                // Primeiro, pegar dados atuais
                const getResponse = await fetch('/.netlify/functions/get-products');
                const currentData = await getResponse.json();
                
                log('Dados atuais carregados', 'info');
                
                // Criar produto de teste
                const testProduct = {
                    id: `test-${Date.now()}`,
                    name: `Produto Teste ${new Date().toLocaleTimeString()}`,
                    category: 'geral',
                    rl_price: 99.99,
                    kks_price: 50.0,
                    description: 'Produto criado automaticamente para teste da API',
                    is_active: true,
                    created_at: new Date().toISOString(),
                    image_url: '',
                    video_url: '',
                    quantity: 1,
                    parcelado_price: 0,
                    purchased_value: 0
                };
                
                // Adicionar aos dados atuais
                const updatedData = {
                    ...currentData,
                    products: [...(currentData.products || []), testProduct]
                };
                
                // Remover info de debug antes de enviar
                delete updatedData._debug;
                
                log(`Enviando ${updatedData.products.length} produtos...`, 'info');
                
                const postResponse = await fetch('/.netlify/functions/update-products', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer teste123'
                    },
                    body: JSON.stringify(updatedData)
                });
                
                const result = await postResponse.json();
                
                const testResult = {
                    status: postResponse.ok ? 'SUCCESS' : 'ERROR',
                    httpStatus: postResponse.status,
                    response: result,
                    testProduct: testProduct
                };
                
                resultDiv.innerHTML = JSON.stringify(testResult, null, 2);
                
                if (postResponse.ok) {
                    log('‚úÖ POST API funcionando! Produto de teste adicionado', 'success');
                } else {
                    log(`‚ùå Erro no POST: ${postResponse.status}`, 'error');
                }
                
            } catch (error) {
                resultDiv.innerHTML = `ERRO: ${error.message}`;
                log(`‚ùå Erro no teste POST: ${error.message}`, 'error');
            }
        }
        
        // Auto-executar verifica√ß√£o de ambiente
        document.addEventListener('DOMContentLoaded', () => {
            checkEnvironment();
            log('üöÄ Debug API carregado e pronto!', 'success');
        });
    </script>
</body>
</html>